parameters:
  name: ''
  path: ''

steps:
  - bash: |
      cd ./${{ parameters.path }}/${{ parameters.name }}/config
      sed -i.bu 's/IGRAPHICS_NANOVG IGRAPHICS_METAL/IGRAPHICS_LICE/' ${{ parameters.name }}-mac.xcconfig
      sed -i.bu 's/\/\/$(IGRAPHICS_LNK_FLAGS)/$(IGRAPHICS_LNK_FLAGS)/' ${{ parameters.name }}-mac.xcconfig
    displayName: Set graphics string LICE
    condition: ${{ eq(${{variables['Build.graphics']}}, 'LICE') }}

  - bash: |
      cd ./${{ parameters.path }}/${{ parameters.name }}/config
      sed -i.bu 's/IGRAPHICS_NANOVG IGRAPHICS_METAL/IGRAPHICS_CAIRO/' ${{ parameters.name }}-mac.xcconfig
      sed -i.bu 's/\/\/$(IGRAPHICS_LNK_FLAGS)/$(IGRAPHICS_LNK_FLAGS)/' ${{ parameters.name }}-mac.xcconfig
    displayName: Set graphics string CAIRO
    condition: ${{ eq(${{variables['Build.graphics']}}, 'CAIRO') }}

  - bash: |
      cd ./${{ parameters.path }}/${{ parameters.name }}/config
      sed -i.bu 's/IGRAPHICS_NANOVG IGRAPHICS_METAL/IGRAPHICS_AGG/' ${{ parameters.name }}-mac.xcconfig
      sed -i.bu 's/\/\/$(IGRAPHICS_LNK_FLAGS)/$(IGRAPHICS_LNK_FLAGS)/' ${{ parameters.name }}-mac.xcconfig
    displayName: Set graphics string AGG
    condition: ${{ eq(${{variables['Build.graphics']}}, 'AGG') }}

  - task: Xcode@5
    inputs:
      sdk: 'macosx10.13'
      xcWorkspacePath: '${{ parameters.path }}/${{ parameters.name }}/projects/${{ parameters.name }}-macOS.xcodeproj'
      args: '-target ${{ ${{variables['Build.graphics']}} }} -xcconfig ${{ parameters.path }}/${{ parameters.name }}/config/${{ parameters.name }}-mac.xcconfig'
      configuration: '${{ variables['Build.configuration'] }}'
      xcodeVersion: '9'
    displayName: Build Xcode project

  - bash: |
      rm -r ${{ parameters.path }}/${{ parameters.name }}/build-mac/*.build
      rm -r ${{ parameters.path }}/${{ parameters.name }}/build-mac/PCH
    displayName: Delete unwanted files

  - task: PublishPipelineArtifact@0
    inputs:
      artifactName: 'MAC_${{ parameters.name }}_${{ ${{variables['Build.graphics']}} }}'
      targetPath: '${{ parameters.path }}/${{ parameters.name }}/build-mac'
    displayName: Publish ${{ parameters.name }}